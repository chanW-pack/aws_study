## RDS 구성 아키텍쳐

---

데이터베이스는 관리가 중요하다.

만일 어느 데이터베이스가 장애가 나면 재빨리 다른 데이터베이스로 옮겨 서비스를 
지속하는 등 고가용적인 관리가 필요하다.

또한 트래픽이 몰려 데이터베이스 서버가 터지는것 대비해 분산 기법도 이용해야 한다.

AWS RDS는 데이터베이스를 보다 효율적으로 관리할 수 있게 하는 
인프라 아키텍쳐 방법 3가지를 제공한다.

![Untitled 14](https://user-images.githubusercontent.com/84123877/191171497-d64e81c4-1e4f-42b5-9de2-39743f2dd908.png)

## RDS Multi AZ 구조

---

![Untitled 15](https://user-images.githubusercontent.com/84123877/191171500-3e6c826c-b0d2-4408-8ec8-9aa7391988da.png)

> RDS 멀티 AZ는 위 사진처럼 **두 개 이상의 AZ에 걸쳐 데이터베이스를 구축**하고
원본과 다른 **DB(Standby)**를 자동으로 동기화(Sync)하는 구조이다.
> 

<aside>
💡 **Stnadby란?**
돌발 사태로 예정된 기능이 이뤄지지 못할 경우를 대비한 ‘임시’를 뜻한다.

</aside>

Multi AZ는 AWS에 의해서 자동으로 관리가 이루어 진다.

만약 RDS DB를 만들고, DB에 특정 레코드를 insert할 시, 
다른 AZ(Availabitlity Zone)에 똑같은 복제본이 만들어지게 된다.

그리고 유사시 우리가 현재 사용하고 있는 메인 DB에 문제가 생길 경우 RDS는 이를 즉시 발견하고
다른 AZ에 만들어진 복제본을 원본 DB로 승격시켜 그대로 사용하게 된다.

이를 Disaster Recovery(재해 복구)라고 한다.

### Multi AZ 재해 복구 원리

일반적인 경우 DNS 주소로 RDS Primary 인스턴스에 접속하여 사용한다.

그런다 아래 사진처럼 기본적으로 **Standby DB는 접근이 불가능**하다. (DNS가 부여되지 않음)

장애 복구용 백업 인스턴스이기 때문에 Standby DB는 숨겨져 있기 때문이다.

![Untitled 16](https://user-images.githubusercontent.com/84123877/191171501-985137b9-8f0d-4043-be9d-e18c15136a62.png)

그러다 만약 **RDS Primary에 장애가 발생하면**, 다음과 같이 장애 복구가 이루어진다.

![Untitled 17](https://user-images.githubusercontent.com/84123877/191171503-0ef7e4eb-e326-4224-a807-8a33bfe674a7.png)

1. RDS Primary에 문제가 생기면, 자동으로 DNS를 Standby 인스턴스로 연동을 해준다.
2. 그리고 기존에 RDS Primary와의 연결을 끊어준다.
3. 이것을 **fail over(fail 났을 때 복구하는 과정)** 라고 한다.
4. EC2 입장에서는 동일한 address로 바라보고 있기 때문에 장애를 느끼지 못하게 된다.
5. 굉장히 빠른속도로 장애복구 가능 O

### Multi AZ 용도

멀티 AZ 구조의 단점은 예비용 인스턴스가 하나 더 돌고 있다는 것이기 때문에
**비용이 두배**가 든다는 점이다.

그리고 예비용 만들어진 인스턴스는 활용을 안하고 그저 만일을 대비해서 그저 대기 상태로 된다.

따라서 멀티 AZ 구조는 **퍼포먼스의 상승 효과가 아닌 안정성을 위한 서비스**이다.

그래서 Multu AZ는 복제본을 만든다고 해서 성능이 더 좋아지는 것은 아니지만, 
만약 성능개선이 주목적이라면 **Read Replica**를 이용해야 한다.

## Read Replica (읽기 전용 복제본)

---

![Untitled 18](https://user-images.githubusercontent.com/84123877/191171504-9226819d-b76b-4206-a5b0-d25a0d1a78d3.png)

> Read Replica(읽기 전용 복제본)은 위 그림처럼 **RDS Primary를 복제**해서
**DB쓰기는 RDS Primary에서 처리**하고, **DB 읽기는 복제한 복제본에서 처리**하는 구조이다.
> 

그리하여 **읽기 전용** 복제본이라는 이름이다.

이렇게 읽기와 쓰기를 나누어, 만일 서비스에서 DB 읽기 위주의 작업이 많을 경우를 
대비할 수 있다. (Read Pelica를 여러개 만들어 **부하를 분산** 가능)

<aside>
💡 즉, 쓰지 작업은 마스터 DB 인스턴스에 하고 읽기 작업은 Read Replica에 할당하면
마스터 DB 인스턴스의 부하를 줄일 수 있는 원리이다.

</aside>

Read Replica의 복제본들은 같은 AZ에 있을 수도 있고, 다른 AZ에 있을 수도 있고
심지어는 다른 리전에 있을 수도 있다.

그리고 Read Replica는 멀티 AZ와는 달리 각각의 **복제본 인스턴스에 DNS가 각각 부여**되서
접근이 가능하다. (당연히 읽기 동작을 하려먼 접근해야 되니……)

이렇게 데이터베이스를 복제하여 쓰기와 읽기를 분별하여 트래픽을 분산하는 기술을
**데이터베이스 Replication 이라고 한다.**
흔히 서버를 이중화 하는 것처럼 데이터베이스를 이중화 한다고 이해하면 된다.

### 데이터베이스 Replication

Replication이란 백업과 성능 향샹을 위해서 데이터베이스를 여러 대의 서버의
복제하는 행위를 뜻한다.

원본 데이터가 위치하는 서버를 **마스터**라고 하고, 
그 원본을 복제한 서버를 **슬레이브** 라고 칭한다.

![Untitled 19](https://user-images.githubusercontent.com/84123877/191171506-0209163f-f753-4452-a51a-07b8c2f612f7.png)

> 위와 같이 Delete, Update, Insert 작업이 실행될 땐 RDS DB Instance로 요청이 들어가고,
Select 작업을 수행해야 한다면 Read Replica에 요청이 들어가게 되는 것이다.
> 

이를 통해 읽기 위주의 작업이 많을 경우 부하를 분산할 수 있게 된다.

따라서 Read Replica는 **성능 극대화**를 위해 존재하기에,
Read heavy work가 많을 시 서버 다운을 대비하여 사용하게 된다.

### Read Replica VS Multu-AZ

---

둘 다 RDS Primary 인스턴스를 복제한다는 점은 같지만,
앞서 Multy-AZ 복제와 혼동하면 안된다.

1. 복제의 목적
Multi-AZ 복제는 **서비스가 항상 가동해야 하는 가용성**을 위한 것이다.
Read Replica 기능은 Disaster Recovery(재해 복구) 용도가 아니다. 
즉, 안정성을 위한 서비스가 아닌 **퍼포먼스를 위한 서비스**이다.

Multi-AZ 복제본은 그저 안정성을 위해 아무것도 하지 않은 생 인스턴스를 생성하는 것이지만,
Read Replica는 실제로 다른 EC2들과 상호작용을 하기 때문이다.

1. 복구 방법
그리고 Read Replica는 Multi-AZ와 달리 **fail over(자동 복구)가 불가능**하다.
만약 RDS Primary가 고장났을 경우, 관리자가 직접 수동으로 쓰기 DNS를 복제본에 연결해
복구를 해주어야 한다.

1. 복제 데이터 일관성
Multi-AZ 복제는 쓰기 작업을 실시한 즉시 자동으로 예비 인스턴스에 복제된다.
따라서 두 DB 인스턴스의 **데이터가 항상 일치하는 것을 보장**한다.
 그러나, 복제된 예비 인스턴스에서는 읽기 작업을 할 수 없다.
Read Replica의 경우 쓰기 작업을 실시하면 약간의 시간차를 가지고 데이터가 복제되게 된다.
따라서 **데이터가 일치하지 않을 수** 있다.

### Read Replica (읽기 전용 복제본) 정리

---

- 총 **5개**까지 생성 가능
- 복제본의 복제본도 생성 가능
- 각각의 **복제본은 고유 DNS가 할당** 됨 → 접근 가능
- 원본 DB의 장애 발생 시 **수동으로 DNS 변경이 필요함**
- 복제본 자체에 Multi-AZ 설정하여 둘이 조합하여 인프라 구성 가능
- 단, 자동 백업이 활성화 되어있어야 읽기 전용 복제본 생성 가능
- 각 DB간의 데이터나 엔진 버전이 다를 수 있음 (멀티 AZ는 완전히 똑같은 DB 인스턴스가 생성되는 것이기 때문에 버젼이 같지만, 이건 아니다)

## RDS Multi Region

---

![Untitled 20](https://user-images.githubusercontent.com/84123877/191171508-4c1a497a-ee74-4856-975b-a14a9a6474e9.png)

- **다른 리전**에 지속적으로 동기화 시키는 DB 클러스터 생성 (Async 복제)
- 예를 들어 유럽 국가에 서비스를 한다고 가정하자.서울에 마스터 리전을 두고 유럽에 Read Replica를 둔다면 유럽 현지에서는 Read Replica로 읽기 때문에 latency(지연시간)가 줄어든다.우리나라에서는 읽기 전용 복제본에 데이터 복제만 해주면 된다.
- RDS 멀티 리전은 주로 로컬 퍼포먼스 또는 DR(disaster recovery)시나리오로 활용
    - **로컬 퍼포먼스** : 그 지역에 있는 사람들이 빨리 읽을 수 있게 해줌
    - **DR(disaster recovery)시나리오** : 만약 서울에 폭탄이 터져서 리전이 fail이 된다면 다른리전을 마스터로 만드는 구성
- 각 리전별로 자동 백업 가능
- 리전별로 Multi-AZ 가능

---
